<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mente Maestra: Desafío Matemático</title>
    
    <!-- PWA: Color del Navegador -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="msapplication-navbutton-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Mente Maestra">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Manifest dinámico para PWA -->
    <link rel="manifest" id="my-manifest">
    <script>
        const manifest = {
            "name": "Mente Maestra",
            "short_name": "MenteMaestra",
            "start_url": ".",
            "display": "standalone",
            "orientation": "portrait",
            "background_color": "#f3f4f6",
            "theme_color": "#4f46e5",
            "description": "Juego de agilidad mental matemática.",
            "icons": [
                {
                    "src": "https://raw.githubusercontent.com/lucide-icons/lucide/main/icons/brain.svg",
                    "sizes": "any",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                },
                {
                    "src": "https://raw.githubusercontent.com/lucide-icons/lucide/main/icons/brain.svg",
                    "sizes": "512x512",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                }
            ]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#my-manifest').setAttribute('href', manifestURL);
    </script>
    
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.2s ease-in-out; }

        @keyframes redPulse {
            0% { box-shadow: inset 0 0 0 rgba(255, 0, 0, 0); background-color: rgb(243 244 246); }
            50% { box-shadow: inset 0 0 150px rgba(220, 38, 38, 0.4); background-color: rgb(254 226 226); }
            100% { box-shadow: inset 0 0 0 rgba(255, 0, 0, 0); background-color: rgb(243 244 246); }
        }
        .urgent-pulse-bg { 
            animation: redPulse 1s infinite; 
            transition: all 0.3s ease;
        }

        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: fixed;
            width: 12px;
            height: 12px;
            top: -20px;
            z-index: 9999;
            pointer-events: none;
        }

        .key-hint {
            position: absolute;
            bottom: -10px;
            right: -10px;
            background: #333;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .key-hint { display: none; }
        }

        /* Scrollbar personalizada */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        body { visibility: hidden; touch-action: manipulation; min-height: 100vh; } 
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans selection:bg-indigo-200 selection:text-indigo-900">
    
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { Clock, Trophy, Play, RotateCcw, Calculator, Brain, X, CheckCircle2, Award, Volume2, VolumeX, PartyPopper, Users, User, Zap, Infinity, Flag, Download, Globe } from 'https://esm.sh/lucide-react@0.263.1';

        // --- SISTEMA DE SONIDO ---
        const soundSystem = {
            ctx: null,
            init: function() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            playTone: function(freq, type, duration, time = 0) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime + time);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime + time);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + time + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(this.ctx.currentTime + time);
                osc.stop(this.ctx.currentTime + time + duration);
            },
            playTick: function(urgent = false) {
                this.init();
                urgent ? this.playTone(800, 'square', 0.1) : this.playTone(400, 'sine', 0.1);
            },
            playCorrect: function() {
                this.init();
                this.playTone(600, 'sine', 0.1);
                this.playTone(1200, 'sine', 0.2, 0.1);
            },
            playWrong: function() {
                this.init();
                this.playTone(150, 'sawtooth', 0.3);
            },
            playGameOver: function() {
                this.init();
                this.playTone(300, 'triangle', 0.5);
                this.playTone(250, 'triangle', 0.5, 0.4);
                this.playTone(200, 'triangle', 1.0, 0.8);
            },
            playWin: function() {
                this.init();
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    this.playTone(freq, 'square', 0.2, i * 0.15);
                });
                this.playTone(1046.50, 'square', 0.6, 0.6);
            }
        };

        const Confetti = () => {
            const [particles, setParticles] = useState([]);
            useEffect(() => {
                const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffae00'];
                setParticles(Array.from({ length: 100 }).map((_, i) => ({
                    id: i,
                    left: Math.random() * 100 + 'vw',
                    bg: colors[Math.floor(Math.random() * colors.length)],
                    delay: Math.random() * 1 + 's',
                    duration: Math.random() * 3 + 2 + 's',
                    size: Math.random() * 8 + 8 + 'px'
                })));
            }, []);
            return React.createElement(React.Fragment, null,
                particles.map(p => 
                    React.createElement("div", { key: p.id, className: "confetti", style: { left: p.left, backgroundColor: p.bg, width: p.size, height: p.size, animation: `fall ${p.duration} linear ${p.delay} infinite` } })
                )
            );
        };

        // --- TRADUCCIONES ---
        const translations = {
            es: {
                title: "Mente Maestra",
                subtitle: "Desafío Matemático",
                chooseMode: "Elige tu modo de juego",
                modes: {
                    classic: { label: "Clásico", desc: "60 segundos Time Attack" },
                    survival: { label: "Survival", desc: "Empiezas con 10s. ¡Gana tiempo!" },
                    zen: { label: "Zen", desc: "Sin tiempo. Solo práctica." },
                    multi: { label: "Versus", desc: "Mayor puntaje en 60s (2 Jugadores)" }
                },
                difficulties: {
                    easy: "Fácil",
                    medium: "Medio",
                    hard: "Difícil"
                },
                buttons: {
                    play: "JUGAR",
                    install: "Instalar",
                    save: "Guardar",
                    menu: "Menú Principal",
                    quit: "Salir de la partida"
                },
                game: {
                    points: "Puntos",
                    time: "Tiempo",
                    player: "Jugador",
                    solve: "Resuelve",
                    exitTitle: "Salir de la partida"
                },
                gameOver: {
                    newRecord: "¡NUEVO RÉCORD!",
                    beatScore: "¡Has superado la mejor puntuación!",
                    gameOver: "¡Juego Terminado!",
                    quickMind: "¿Qué tan rápida es tu mente?",
                    playerWins: "¡Jugador {0} Gana!",
                    masterfulVictory: "Victoria magistral",
                    draw: "¡Empate!",
                    drawDesc: "Ambos son igual de rápidos",
                    sessionEnded: "Sesión Finalizada",
                    goodTraining: "Buen entrenamiento.",
                    ranking: "Ranking Local",
                    totalPoints: "Puntos Totales",
                    namePlaceholder: "Nombre"
                }
            },
            en: {
                title: "Mastermind",
                subtitle: "Math Challenge",
                chooseMode: "Choose your game mode",
                modes: {
                    classic: { label: "Classic", desc: "60 seconds Time Attack" },
                    survival: { label: "Survival", desc: "Start with 10s. Earn time!" },
                    zen: { label: "Zen", desc: "No timer. Just practice." },
                    multi: { label: "Versus", desc: "Highest score in 60s (2 Players)" }
                },
                difficulties: {
                    easy: "Easy",
                    medium: "Medium",
                    hard: "Hard"
                },
                buttons: {
                    play: "PLAY",
                    install: "Install",
                    save: "Save",
                    menu: "Main Menu",
                    quit: "Quit Game"
                },
                game: {
                    points: "Score",
                    time: "Time",
                    player: "Player",
                    solve: "Solve",
                    exitTitle: "Quit Game"
                },
                gameOver: {
                    newRecord: "NEW RECORD!",
                    beatScore: "You beat the high score!",
                    gameOver: "Game Over!",
                    quickMind: "How fast is your mind?",
                    playerWins: "Player {0} Wins!",
                    masterfulVictory: "Masterful victory",
                    draw: "Draw!",
                    drawDesc: "Both are equally fast",
                    sessionEnded: "Session Ended",
                    goodTraining: "Good training.",
                    ranking: "Local Ranking",
                    totalPoints: "Total Score",
                    namePlaceholder: "Name"
                }
            },
            pt: {
                title: "Mente Mestra",
                subtitle: "Desafio Matemático",
                chooseMode: "Escolha seu modo de jogo",
                modes: {
                    classic: { label: "Clássico", desc: "60 segundos Time Attack" },
                    survival: { label: "Sobrevivência", desc: "Comece com 10s. Ganhe tempo!" },
                    zen: { label: "Zen", desc: "Sem tempo. Apenas prática." },
                    multi: { label: "Versus", desc: "Maior pontuação em 60s (2 Jogadores)" }
                },
                difficulties: {
                    easy: "Fácil",
                    medium: "Médio",
                    hard: "Difícil"
                },
                buttons: {
                    play: "JOGAR",
                    install: "Instalar",
                    save: "Salvar",
                    menu: "Menu Principal",
                    quit: "Sair do jogo"
                },
                game: {
                    points: "Pontos",
                    time: "Tempo",
                    player: "Jogador",
                    solve: "Resolva",
                    exitTitle: "Sair do jogo"
                },
                gameOver: {
                    newRecord: "NOVO RECORDE!",
                    beatScore: "Você superou a pontuação máxima!",
                    gameOver: "Fim de Jogo!",
                    quickMind: "Quão rápida é sua mente?",
                    playerWins: "Jogador {0} Vence!",
                    masterfulVictory: "Vitória magistral",
                    draw: "Empate!",
                    drawDesc: "Ambos são igualmente rápidos",
                    sessionEnded: "Sessão Encerrada",
                    goodTraining: "Bom treinamento.",
                    ranking: "Ranking Local",
                    totalPoints: "Pontuação Total",
                    namePlaceholder: "Nome"
                }
            },
            fr: {
                title: "Cerveau de Génie",
                subtitle: "Défi Mathématique",
                chooseMode: "Choisissez votre mode",
                modes: {
                    classic: { label: "Classique", desc: "60 secondes Contre-la-montre" },
                    survival: { label: "Survie", desc: "Commencez avec 10s. Gagnez du temps!" },
                    zen: { label: "Zen", desc: "Pas de temps. Juste pour s'entraîner." },
                    multi: { label: "Versus", desc: "Meilleur score en 60s (2 Joueurs)" }
                },
                difficulties: {
                    easy: "Facile",
                    medium: "Moyen",
                    hard: "Difficile"
                },
                buttons: {
                    play: "JOUER",
                    install: "Installer",
                    save: "Sauvegarder",
                    menu: "Menu Principal",
                    quit: "Quitter le jeu"
                },
                game: {
                    points: "Points",
                    time: "Temps",
                    player: "Joueur",
                    solve: "Résoudre",
                    exitTitle: "Quitter le jeu"
                },
                gameOver: {
                    newRecord: "NOUVEAU RECORD!",
                    beatScore: "Vous avez battu le meilleur score!",
                    gameOver: "Jeu Terminé!",
                    quickMind: "À quel point votre esprit est-il rapide?",
                    playerWins: "Le Joueur {0} Gagne!",
                    masterfulVictory: "Victoire magistrale",
                    draw: "Égalité!",
                    drawDesc: "Vous êtes tous les deux aussi rapides",
                    sessionEnded: "Session Terminée",
                    goodTraining: "Bon entraînement.",
                    ranking: "Classement Local",
                    totalPoints: "Score Total",
                    namePlaceholder: "Nom"
                }
            },
            it: {
                title: "Mente Maestra",
                subtitle: "Sfida Matematica",
                chooseMode: "Scegli la modalità",
                modes: {
                    classic: { label: "Classico", desc: "60 secondi Time Attack" },
                    survival: { label: "Sopravvivenza", desc: "Inizia con 10s. Guadagna tempo!" },
                    zen: { label: "Zen", desc: "Nessun tempo. Solo pratica." },
                    multi: { label: "Versus", desc: "Punteggio più alto in 60s (2 Giocatori)" }
                },
                difficulties: {
                    easy: "Facile",
                    medium: "Medio",
                    hard: "Difficile"
                },
                buttons: {
                    play: "GIOCA",
                    install: "Installa",
                    save: "Salva",
                    menu: "Menu Principale",
                    quit: "Esci dal gioco"
                },
                game: {
                    points: "Punti",
                    time: "Tempo",
                    player: "Giocatore",
                    solve: "Risolvi",
                    exitTitle: "Esci dal gioco"
                },
                gameOver: {
                    newRecord: "NUOVO RECORD!",
                    beatScore: "Hai battuto il record!",
                    gameOver: "Gioco Finito!",
                    quickMind: "Quanto è veloce la tua mente?",
                    playerWins: "Vince il Giocatore {0}!",
                    masterfulVictory: "Vittoria magistrale",
                    draw: "Pareggio!",
                    drawDesc: "Entrambi siete ugualmente veloci",
                    sessionEnded: "Sessione Terminata",
                    goodTraining: "Buon allenamento.",
                    ranking: "Classifica Locale",
                    totalPoints: "Punteggio Totale",
                    namePlaceholder: "Nome"
                }
            }
        };

        // --- UTILIDADES MATEMÁTICAS ---
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        const generateSimpleExpression = (diff) => {
             const ops = diff === 'easy' ? ['+', '-'] : diff === 'medium' ? ['+', '-', '*'] : ['+', '-', '*', '/'];
             const operator = ops[Math.floor(Math.random() * ops.length)];
             let n1, n2, ans, symbol;

             switch (operator) {
                case '+':
                    symbol = '+';
                    n1 = getRandomInt(1, diff === 'easy' ? 20 : 50);
                    n2 = getRandomInt(1, diff === 'easy' ? 20 : 50);
                    ans = n1 + n2;
                    break;
                case '-':
                    symbol = '-';
                    n1 = getRandomInt(5, diff === 'easy' ? 30 : 100);
                    n2 = getRandomInt(1, n1);
                    ans = n1 - n2;
                    break;
                case '*':
                    symbol = '×';
                    n1 = getRandomInt(2, diff === 'easy' ? 5 : 12);
                    n2 = getRandomInt(2, diff === 'easy' ? 5 : 12);
                    ans = n1 * n2;
                    break;
                case '/':
                    symbol = '÷';
                    ans = getRandomInt(2, 12);
                    n2 = getRandomInt(2, 10);
                    n1 = ans * n2;
                    break;
            }
            return { display: `${n1} ${symbol} ${n2}`, value: ans };
        };

        // --- GENERADOR DE PROBLEMAS ---
        const generateMathProblem = (diff) => {
            const types = ['arithmetic'];
            if (diff !== 'easy') {
                types.push('unknown'); 
                types.push('comparison'); 
            }
            if (diff === 'hard') {
                types.push('power');
                types.push('root');
            }

            const type = types[Math.floor(Math.random() * types.length)];
            
            if (type === 'arithmetic') {
                const exp = generateSimpleExpression(diff);
                return { display: `${exp.display} = ?`, answer: exp.value, type: 'number' };
            }
            if (type === 'unknown') {
                const exp = generateSimpleExpression(diff);
                const parts = exp.display.split(' ');
                const hideIndex = Math.random() > 0.5 ? 0 : 2;
                const answer = parseInt(parts[hideIndex]);
                parts[hideIndex] = '?';
                return { display: `${parts.join(' ')} = ${exp.value}`, answer: answer, type: 'number' };
            }
            if (type === 'comparison') {
                const exp1 = generateSimpleExpression(diff);
                const exp2 = generateSimpleExpression(diff);
                let symbol = '=';
                if (exp1.value > exp2.value) symbol = '>';
                if (exp1.value < exp2.value) symbol = '<';
                return { display: `${exp1.display}  ?  ${exp2.display}`, answer: symbol, type: 'symbol' };
            }
            if (type === 'power') {
                const base = getRandomInt(2, 15);
                return { display: `${base}²`, answer: base * base, type: 'number' };
            }
            if (type === 'root') {
                const root = getRandomInt(2, 15);
                const val = root * root;
                return { display: `√${val}`, answer: root, type: 'number' };
            }
        };

        const generateMathOptions = (correctAnswer, type) => {
            if (type === 'symbol') {
                return ['>', '<', '=', '≠'].sort(() => Math.random() - 0.5);
            }
            const opts = new Set([correctAnswer]);
            while (opts.size < 4) {
                const offset = (Math.floor(Math.random() * 5) + 1) * (Math.random() > 0.5 ? 1 : -1);
                let val = correctAnswer + offset;
                if (correctAnswer >= 0 && val < 0) val = Math.abs(val);
                if (val !== correctAnswer) opts.add(val);
            }
            return Array.from(opts).sort(() => Math.random() - 0.5);
        };

        const MathTriviaGame = () => {
            const [gameState, setGameState] = useState('menu');
            const [gameMode, setGameMode] = useState('classic');
            const [difficulty, setDifficulty] = useState('easy');
            const [timeLeft, setTimeLeft] = useState(60);
            const [highScores, setHighScores] = useState([]);
            const [playerName, setPlayerName] = useState('');
            const [soundEnabled, setSoundEnabled] = useState(true);
            const [isNewRecord, setIsNewRecord] = useState(false);
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [lang, setLang] = useState('es'); // Estado para el idioma
            
            const [p1State, setP1State] = useState({ score: 0, problem: null, options: [], lastResult: null });
            const [p2State, setP2State] = useState({ score: 0, problem: null, options: [], lastResult: null });

            const timerRef = useRef(null);

            const t = translations[lang]; // Helper para traducciones

            const modesConfig = {
                classic: { label: t.modes.classic.label, icon: Clock, desc: t.modes.classic.desc },
                survival: { label: t.modes.survival.label, icon: Zap, desc: t.modes.survival.desc },
                zen: { label: t.modes.zen.label, icon: Infinity, desc: t.modes.zen.desc },
                multi: { label: t.modes.multi.label, icon: Users, desc: t.modes.multi.desc }
            };

            const difficultyConfig = {
                easy: { label: t.difficulties.easy, color: 'bg-green-500', bonus: 1 },
                medium: { label: t.difficulties.medium, color: 'bg-yellow-500', bonus: 2 },
                hard: { label: t.difficulties.hard, color: 'bg-red-500', bonus: 3 }
            };

            useEffect(() => {
                const savedScores = localStorage.getItem('mathTriviaHighScores');
                const savedLang = localStorage.getItem('mathTriviaLang');
                if (savedScores) setHighScores(JSON.parse(savedScores));
                if (savedLang) setLang(savedLang);
                document.body.style.visibility = 'visible';
                
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                });
            }, []);

            const changeLanguage = (newLang) => {
                setLang(newLang);
                localStorage.setItem('mathTriviaLang', newLang);
            }

            const handleInstall = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        setDeferredPrompt(null);
                    }
                }
            };

            useEffect(() => {
                if (gameState !== 'playing') return;
                const handleKeyDown = (e) => {
                    const key = e.key.toLowerCase();
                    if (key === 'escape') { endGameCheck(); return; }
                    
                    const p1Keys = ['a', 's', 'd', 'f'];
                    const p1Idx = p1Keys.indexOf(key);
                    if (p1Idx !== -1 && p1State.options[p1Idx] !== undefined) {
                        handleAnswer(1, p1State.options[p1Idx]);
                    }
                    if (gameMode === 'multi') {
                        const p2Keys = ['h', 'j', 'k', 'l'];
                        const p2Idx = p2Keys.indexOf(key);
                        if (p2Idx !== -1 && p2State.options[p2Idx] !== undefined) {
                            handleAnswer(2, p2State.options[p2Idx]);
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [gameState, gameMode, p1State, p2State]);

            const getNewProblem = () => {
                const p = generateMathProblem(difficulty);
                const o = generateMathOptions(p.answer, p.type);
                return { problem: p, options: o };
            };

            const startGame = () => {
                if(soundEnabled) soundSystem.init();
                
                let initialTime = 60;
                if (gameMode === 'survival') initialTime = 10;
                if (gameMode === 'zen') initialTime = null; 
                
                setTimeLeft(initialTime);
                setGameState('playing');
                setIsNewRecord(false);
                
                const initProblem = getNewProblem();
                setP1State({ score: 0, problem: initProblem.problem, options: initProblem.options, lastResult: null });
                
                if (gameMode === 'multi') {
                    const p2Init = getNewProblem();
                    setP2State({ score: 0, problem: p2Init.problem, options: p2Init.options, lastResult: null });
                }
                
                if (timerRef.current) clearInterval(timerRef.current);
                
                if (gameMode !== 'zen') {
                    timerRef.current = setInterval(() => {
                        setTimeLeft((prev) => {
                            if (prev <= 1) { endGameCheck(); return 0; }
                            if (soundEnabled) { prev <= 6 ? soundSystem.playTick(true) : soundSystem.playTick(false); }
                            return prev - 1;
                        });
                    }, 1000);
                }
            };

            const p1Ref = useRef(p1State);
            const p2Ref = useRef(p2State);
            useEffect(() => { p1Ref.current = p1State; p2Ref.current = p2State; }, [p1State, p2State]);

            const endGameCheck = (winnerId = null) => {
                clearInterval(timerRef.current);
                setGameState('gameover');
                
                let finalScore = gameMode === 'multi' ? Math.max(p1Ref.current.score, p2Ref.current.score) : p1Ref.current.score;
                const topScore = highScores.length > 0 ? highScores[0].score : 0;
                
                if (gameMode !== 'zen' && gameMode !== 'multi' && finalScore > topScore) {
                    setIsNewRecord(true);
                    if (soundEnabled) soundSystem.playWin();
                } else {
                    if (soundEnabled && gameMode !== 'zen') soundSystem.playGameOver();
                }
            };

            const handleAnswer = (playerNum, selectedOption) => {
                const currentState = playerNum === 1 ? p1State : p2State;
                const setState = playerNum === 1 ? setP1State : setP2State;
                if (currentState.lastResult) return; 

                const isCorrect = selectedOption === currentState.problem.answer;
                
                if (isCorrect) {
                    const points = difficultyConfig[difficulty].bonus * 10;
                    const next = getNewProblem();
                    
                    setState(prev => ({
                        ...prev,
                        score: prev.score + points,
                        lastResult: 'correct',
                        problem: next.problem,
                        options: next.options
                    }));

                    if (gameMode === 'survival') setTimeLeft(prev => Math.min(prev + 3, 60)); 
                    if (soundEnabled) soundSystem.playCorrect();
                } else {
                    setState(prev => ({
                        ...prev,
                        score: (gameMode === 'classic' || gameMode === 'zen') ? prev.score : Math.max(0, prev.score - 5),
                        lastResult: 'wrong'
                    }));
                    if (gameMode === 'classic' || gameMode === 'survival') setTimeLeft(prev => Math.max(0, prev - 5));
                    if (soundEnabled) soundSystem.playWrong();
                }
                setTimeout(() => { setState(prev => ({ ...prev, lastResult: null })); }, 300);
            };
            
            const handleMouseAnswer = (playerNum, opt) => handleAnswer(playerNum, opt);

            const saveHighScore = (e) => {
                e.preventDefault();
                if (!playerName.trim()) return;
                if (gameMode === 'zen') return; 

                const scoreToSave = gameMode === 'multi' ? Math.max(p1State.score, p2State.score) : p1State.score;
                const modeLabel = modesConfig[gameMode].label;
                
                const newScore = {
                    id: Date.now(),
                    name: playerName,
                    score: scoreToSave,
                    difficulty: `${difficultyConfig[difficulty].label} (${modeLabel})`,
                    date: new Date().toLocaleDateString()
                };
                const newHighScores = [...highScores, newScore].sort((a, b) => b.score - a.score).slice(0, 10);
                setHighScores(newHighScores);
                localStorage.setItem('mathTriviaHighScores', JSON.stringify(newHighScores));
                setGameState('menu');
                setPlayerName('');
            };

            const PlayerBoard = ({ playerNum, state, keysHint, isRotated, time, showTime }) => {
                const displayText = state.problem?.display || '';
                const fontSizeClass = displayText.length > 10 ? 'text-3xl' : 'text-5xl';

                return React.createElement("div", {
                    className: `flex-1 flex flex-col p-4 transition-all duration-200 relative
                        ${isRotated ? 'rotate-180 border-b-4 border-gray-200' : ''}
                        ${playerNum === 2 && !isRotated ? 'border-l-4 border-gray-200' : ''} 
                        ${state.lastResult === 'correct' ? 'bg-green-50' : ''} 
                        ${state.lastResult === 'wrong' ? 'bg-red-50 shake' : ''}
                        ${isRotated ? 'shadow-inner' : ''}` 
                },
                    React.createElement("div", { className: "flex justify-between items-start mb-2 bg-white p-2 rounded-xl shadow-sm" },
                        React.createElement("div", { className: "flex flex-col" },
                            React.createElement("span", { className: "text-xs font-bold text-gray-400 uppercase" }, `${t.game.player} ${playerNum}`),
                            React.createElement("span", { className: "text-3xl font-black text-indigo-600" }, state.score)
                        ),
                        showTime && React.createElement("div", { className: `flex flex-col items-end ${time <= 10 ? 'text-red-500 animate-pulse' : 'text-gray-500'}` },
                             React.createElement(Clock, { className: "w-4 h-4 mb-1" }),
                             React.createElement("span", { className: "font-mono font-bold text-xl" }, time)
                        )
                    ),
                    React.createElement("div", { className: "flex-grow flex flex-col justify-center items-center mb-2" },
                        React.createElement("h2", { className: `${fontSizeClass} font-black text-gray-800 tracking-tight text-center mb-2 transition-all` }, displayText),
                        state.lastResult && React.createElement("div", { className: "mt-1" },
                            state.lastResult === 'correct' 
                                ? React.createElement(CheckCircle2, { className: "text-green-500 w-8 h-8 animate-bounce" }) 
                                : React.createElement(X, { className: "text-red-500 w-8 h-8 animate-bounce" })
                        )
                    ),
                    React.createElement("div", { className: "grid grid-cols-2 gap-3 h-1/2" }, 
                        state.options.map((opt, idx) => 
                            React.createElement("button", {
                                key: idx,
                                onClick: (e) => {
                                    e.preventDefault();
                                    handleMouseAnswer(playerNum, opt);
                                },
                                className: "relative bg-white hover:bg-indigo-50 active:bg-indigo-200 text-gray-800 font-bold text-2xl rounded-xl shadow-md border-b-4 border-gray-200 active:border-b-0 active:translate-y-1 transition-all touch-manipulation"
                            },
                                opt,
                                gameMode !== 'multi' && !isRotated && React.createElement("div", { className: "key-hint" }, keysHint[idx]),
                                gameMode === 'multi' && !isRotated && React.createElement("div", { className: "key-hint" }, keysHint[idx])
                            )
                        )
                    )
                );
            };

            const renderMenu = () => (
                React.createElement("div", { className: "flex flex-col items-center w-full max-w-md animate-fade-in space-y-6 relative z-10 m-4" },
                    
                    // CONTENEDOR 1: Menú de Configuración
                    React.createElement("div", { className: "w-full bg-white/90 p-6 rounded-3xl backdrop-blur-sm shadow-2xl relative space-y-4" },
                        
                        // Selector de Idioma
                         React.createElement("div", { className: "absolute top-4 left-4 z-50" },
                            React.createElement("div", { className: "relative" },
                                React.createElement(Globe, { className: "absolute left-2 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500 pointer-events-none" }),
                                React.createElement("select", {
                                    value: lang,
                                    onChange: (e) => changeLanguage(e.target.value),
                                    className: "pl-8 pr-3 py-1 bg-white/80 backdrop-blur-sm border border-gray-200 rounded-full text-sm font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm appearance-none cursor-pointer hover:bg-white transition-colors"
                                },
                                    React.createElement("option", { value: "es" }, "Español"),
                                    React.createElement("option", { value: "en" }, "English"),
                                    React.createElement("option", { value: "pt" }, "Português"),
                                    React.createElement("option", { value: "fr" }, "Français"),
                                    React.createElement("option", { value: "it" }, "Italiano")
                                )
                            )
                        ),

                        React.createElement("button", { 
                            onClick: () => setSoundEnabled(!soundEnabled),
                            className: "absolute top-4 right-4 text-gray-400 hover:text-indigo-600 transition-colors p-2 rounded-full hover:bg-indigo-50",
                            title: soundEnabled ? "Silenciar" : "Activar sonido"
                        }, soundEnabled ? React.createElement(Volume2, { className: "w-6 h-6" }) : React.createElement(VolumeX, { className: "w-6 h-6" })),

                        React.createElement("div", { className: "text-center mt-8" },
                            React.createElement(Brain, { className: "w-12 h-12 text-indigo-600 mx-auto mb-1" }),
                            React.createElement("h1", { className: "text-3xl font-extrabold text-gray-800" }, t.title),
                            React.createElement("p", { className: "text-indigo-600 font-bold" }, t.subtitle),
                            React.createElement("p", { className: "text-gray-500 text-xs mt-1" }, t.chooseMode)
                        ),

                        React.createElement("div", { className: "w-full space-y-3" },
                            React.createElement("div", { className: "grid grid-cols-2 gap-2" },
                                Object.entries(modesConfig).map(([key, config]) => 
                                    React.createElement("button", {
                                        key: key,
                                        onClick: () => setGameMode(key),
                                        className: `flex flex-col items-center p-3 rounded-xl border-2 transition-all ${gameMode === key ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-gray-200 hover:bg-gray-50 text-gray-600'}`
                                    },
                                        React.createElement(config.icon, { className: "w-6 h-6 mb-1" }),
                                        React.createElement("span", { className: "font-bold text-sm" }, config.label)
                                    )
                                )
                            ),
                            React.createElement("div", { className: "bg-blue-50 p-3 rounded-lg text-xs text-blue-800 text-center border border-blue-100" },
                                modesConfig[gameMode].desc
                            ),
                            React.createElement("div", { className: "grid grid-cols-3 gap-2" },
                                Object.entries(difficultyConfig).map(([key, config]) => 
                                    React.createElement("button", {
                                        key: key,
                                        onClick: () => setDifficulty(key),
                                        className: `p-2 rounded-lg border-2 text-xs font-bold transition-all ${difficulty === key ? `border-${config.color.split('-')[1]}-500 bg-${config.color.split('-')[1]}-50` : 'border-gray-200'}`
                                    }, config.label)
                                )
                            ),
                            React.createElement("div", { className: "flex gap-2" },
                                React.createElement("button", {
                                    onClick: startGame,
                                    className: "flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transform hover:scale-105 transition flex justify-center gap-2"
                                }, React.createElement(Play, { className: "w-5 h-5" }), t.buttons.play),
                                
                                deferredPrompt && React.createElement("button", {
                                    onClick: handleInstall,
                                    className: "bg-gray-900 hover:bg-gray-800 text-white font-bold px-4 rounded-xl shadow-lg flex flex-col items-center justify-center text-xs"
                                }, React.createElement(Download, { className: "w-5 h-5 mb-1" }), t.buttons.install)
                            )
                        )
                    ),
                    
                    // CONTENEDOR 2: Ranking
                    highScores.length > 0 && React.createElement("div", { className: "w-full bg-white/90 p-6 rounded-3xl backdrop-blur-sm shadow-2xl relative" },
                        React.createElement("h3", { className: "text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b border-gray-100 pb-2" },
                            React.createElement(Trophy, { className: "w-5 h-5 text-yellow-500" }), t.gameOver.ranking
                        ),
                        React.createElement("div", { className: "space-y-2" }, 
                            highScores.map((s, idx) => 
                                React.createElement("div", { key: s.id || idx, className: "flex justify-between items-center p-2 bg-gray-50 rounded-lg text-sm hover:bg-gray-50 transition-colors" },
                                    React.createElement("div", { className: "flex items-center gap-2" },
                                        React.createElement("span", { className: `font-bold w-6 text-center ${idx < 3 ? 'text-yellow-600 bg-yellow-100 rounded-full' : 'text-gray-400'}` }, `#${idx + 1}`),
                                        React.createElement("div", { className: "flex flex-col" },
                                            React.createElement("span", { className: "font-medium text-gray-700 truncate max-w-[120px]" }, s.name),
                                            React.createElement("span", { className: "text-[10px] text-gray-400" }, s.difficulty)
                                        )
                                    ),
                                    React.createElement("div", { className: "flex items-center gap-2" },
                                        React.createElement("span", { className: "font-bold text-indigo-600" }, `${s.score} pts`)
                                    )
                                )
                            )
                        )
                    )
                )
            );

            const renderGameLayout = () => {
                const exitButtonClass = gameMode === 'multi' 
                    ? "absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 bg-white text-gray-500 hover:text-red-500 p-3 rounded-full shadow-2xl border-4 border-gray-100 transition-all transform hover:scale-110" 
                    : "absolute top-4 right-4 z-50 bg-gray-100 hover:bg-red-500 hover:text-white text-gray-500 p-2 rounded-full shadow-md transition-all";

                return React.createElement("div", { className: "w-full max-w-4xl h-[100dvh] md:h-[80vh] bg-gray-200 md:bg-white md:rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row animate-in zoom-in-95 duration-300 relative z-20" },
                    
                    React.createElement("button", {
                        onClick: () => endGameCheck(),
                        className: exitButtonClass,
                        title: t.game.exitTitle
                    }, React.createElement(X, { className: "w-6 h-6" })),

                    gameMode !== 'multi' && React.createElement("div", { className: "absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-40 pointer-events-none" },
                        gameMode === 'zen' ? (
                            React.createElement("div", { className: "bg-teal-600 text-white px-4 py-2 rounded-full shadow-xl border-4 border-white/20 backdrop-blur flex items-center gap-2" },
                                React.createElement(Infinity, { className: "w-6 h-6" })
                            )
                        ) : ( 
                            React.createElement("div", { className: `bg-gray-800 text-white px-4 py-2 rounded-full shadow-xl border-4 border-white/20 backdrop-blur flex items-center gap-2 transform scale-125 ${timeLeft <= 5 ? 'animate-bounce bg-red-600' : ''}` },
                                React.createElement("span", { className: "font-mono font-black text-xl" }, timeLeft)
                            )
                        )
                    ),

                    gameMode === 'multi' && React.createElement("div", { className: "flex-1 flex w-full md:w-1/2 h-1/2 md:h-full bg-gray-50" },
                         React.createElement("div", { className: "w-full h-full flex md:hidden transform rotate-180" },
                            React.createElement(PlayerBoard, { playerNum: 2, state: p2State, keysHint: [], isRotated: false, time: timeLeft, showTime: true }) 
                         ),
                         React.createElement("div", { className: "w-full h-full hidden md:flex" },
                            React.createElement(PlayerBoard, { playerNum: 2, state: p2State, keysHint: ['H', 'J', 'K', 'L'], isRotated: false, time: timeLeft, showTime: true })
                         )
                    ),
                    React.createElement("div", { className: `flex-1 flex w-full ${gameMode === 'multi' ? 'md:w-1/2 h-1/2 md:h-full' : 'h-full'} bg-white` },
                        React.createElement(PlayerBoard, { playerNum: 1, state: p1State, keysHint: ['A', 'S', 'D', 'F'], isRotated: false, time: timeLeft, showTime: gameMode === 'multi' })
                    )
                );
            };

            const renderGameOver = () => {
                let title = t.gameOver.gameOver;
                let subtitle = t.gameOver.quickMind;
                let MainIcon = Award;
                let iconClass = "w-20 h-20 text-gray-400";

                if (gameMode === 'multi') {
                    if (p1State.score === p2State.score) {
                         title = t.gameOver.draw;
                         subtitle = t.gameOver.drawDesc;
                    } else {
                        const winner = p1State.score > p2State.score ? 1 : 2;
                        title = t.gameOver.playerWins.replace('{0}', winner);
                        subtitle = t.gameOver.masterfulVictory;
                        MainIcon = Trophy;
                        iconClass = "w-24 h-24 text-yellow-500 animate-bounce";
                    }
                } else if (isNewRecord) {
                    title = t.gameOver.newRecord;
                    subtitle = t.gameOver.beatScore;
                    MainIcon = PartyPopper;
                    iconClass = "w-24 h-24 text-yellow-500 animate-bounce";
                } else if (gameMode === 'zen') {
                    title = t.gameOver.sessionEnded;
                    subtitle = t.gameOver.goodTraining;
                }

                return React.createElement("div", { className: "w-full max-w-md bg-white p-8 rounded-3xl shadow-2xl text-center animate-in zoom-in duration-300 relative z-10 m-4" },
                    isNewRecord && React.createElement("div", { className: "absolute -top-4 left-0 right-0 text-center" },
                        React.createElement("span", { className: "bg-yellow-400 text-yellow-900 px-4 py-1 rounded-full text-sm font-bold shadow-lg" }, t.gameOver.newRecord)
                    ),
                    React.createElement("div", { className: "flex justify-center mb-4" },
                        React.createElement(MainIcon, { className: iconClass })
                    ),
                    React.createElement("h2", { className: "text-3xl font-bold text-gray-800 mb-2" }, title),
                    React.createElement("p", { className: "text-gray-500 mb-6" }, subtitle),
                    
                    gameMode === 'multi' ? React.createElement("div", { className: "mb-6 p-4 bg-indigo-50 rounded-xl" },
                        React.createElement("div", { className: "flex justify-center gap-8 mt-2" },
                            React.createElement("div", { className: "text-center" }, 
                                React.createElement("div", { className: "text-xs text-gray-500" }, "J1"), 
                                React.createElement("div", { className: "font-black text-xl" }, p1State.score)
                            ),
                            React.createElement("div", { className: "text-center" }, 
                                React.createElement("div", { className: "text-xs text-gray-500" }, "J2"), 
                                React.createElement("div", { className: "font-black text-xl" }, p2State.score)
                            )
                        )
                    ) : React.createElement("div", { className: "mb-6" },
                        React.createElement("div", { className: "text-6xl font-black text-indigo-600" }, p1State.score),
                        React.createElement("div", { className: "text-gray-400 text-sm uppercase font-bold" }, t.gameOver.totalPoints)
                    ),

                    gameMode !== 'zen' && gameMode !== 'multi' && React.createElement("form", { onSubmit: saveHighScore, className: "mb-6" },
                        React.createElement("input", {
                            type: "text",
                            maxLength: "12",
                            placeholder: t.gameOver.namePlaceholder,
                            value: playerName,
                            onChange: (e) => setPlayerName(e.target.value),
                            className: "w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:outline-none text-lg font-bold text-center mb-4",
                            autoFocus: true
                        }),
                        React.createElement("button", {
                            type: "submit",
                            disabled: !playerName.trim(),
                            className: "w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl"
                        }, t.buttons.save)
                    ),
                    React.createElement("button", {
                        onClick: () => setGameState('menu'),
                        className: "flex items-center justify-center gap-2 w-full text-gray-500 hover:text-gray-800 font-bold py-2"
                    }, React.createElement(RotateCcw, { className: "w-4 h-4" }), t.buttons.menu)
                );
            };

            const isUrgent = gameMode !== 'zen' && timeLeft !== null && timeLeft <= 10;

            return React.createElement("div", { className: `min-h-screen font-sans selection:bg-indigo-200 selection:text-indigo-900 flex items-center justify-center md:p-4 transition-colors duration-500 ${isUrgent && gameState === 'playing' ? 'urgent-pulse-bg' : 'bg-gray-100 text-gray-900'}` },
                isNewRecord && gameState === 'gameover' && React.createElement(Confetti),
                React.createElement("div", { className: "fixed inset-0 pointer-events-none opacity-5 overflow-hidden" },
                    React.createElement(Calculator, { className: "absolute top-10 left-10 w-32 h-32 rotate-12" }),
                    React.createElement(Brain, { className: "absolute bottom-20 right-10 w-40 h-40 -rotate-12" }),
                ),
                gameState === 'menu' && renderMenu(),
                gameState === 'playing' && renderGameLayout(),
                gameState === 'gameover' && renderGameOver()
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(MathTriviaGame));

        // --- SERVICE WORKER DUMMY PARA PWA ---
        if ('serviceWorker' in navigator) {
            const swContent = `
                self.addEventListener('install', (e) => {
                    console.log('[SW] Install');
                    self.skipWaiting();
                });
                self.addEventListener('fetch', (e) => {
                    // No hacemos nada, solo dejamos pasar la petición
                });
            `;
            const swBlob = new Blob([swContent], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);
            
            navigator.serviceWorker.register(swUrl)
                .then((reg) => console.log('SW registrado:', reg))
                .catch((err) => console.error('SW error:', err));
        }
    </script>
</body>
</html>